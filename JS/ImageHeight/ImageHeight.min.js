(function(t){class e{constructor(e,i){let a=this;if(a.container=e,1!=a.container.length)throw new Error('Container object "'+e+'" not valid');if(a.minwidth=i.minwidth,a.minheight=i.minheight,a.maxrow=i.maxrow,a.margin=i.margin,a.lazyload=i.lazyload,a.placeholder=i.placeholder,a.showerrors=i.showerrors,a.imagelist=[],a.last_containerwidth=0,a.last_column=0,a.containerwidth=null,a.lasti=0,a.lastnoloaded=0,a.maxcolumn=1,a.allloaded=!1,a.timeoutstep=50,a.timeout=null,a.timeoutlast=0,a.timeoutlasttime=Date.now(),a.time=Date.now(),a.message("Container",a.container),t("a",a.container).css({padding:0,"font-size":0,margin:0}),t("img",a.container).css({"max-width":"100%",margin:a.margin,background:"#cccccc"}),a.lazyload?(t("img",a.container).css({width:t(a.container).width()/a.maxrow-2*a.margin,height:t(a.container).width()/a.maxrow-2*a.margin}),a.placeholder||t("img",a.container).hide()):t("img",a.container).css({height:a.minheight}).hide(),t("img",a.container).each(function(){let e={img:t(this),loaded:!1,error:!1,width:0};a.imagelist.push(e),a.lazyload?null!=t(this).data("src")&&t(this).prop("src","data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="):a.setloaded(e)}),a.message("Image list",a.imagelist),0==a.imagelist.length)throw new Error("No valid images to show");if(t(document).ready(function(){a.message("Start Process..."),a.setcolumns(),t(window).on("resize",function(){a.time=Date.now()}),t(window).on("load resize",function(){a.message("onload resize"),a.setcolumns()})}),a.lazyload){const e={root:null,rootMargin:20*a.minheight+"px",threshold:0};a.observer=new IntersectionObserver(function(e){Array.prototype.forEach.call(e,function(e){if(e.isIntersecting&&(a.observer.unobserve(e.target),"img"==e.target.tagName.toLowerCase())){let i=t(e.target),o=i.data("src");o&&(i.prop("src",o),i.data("src",""));const n=a.imagelist.find(function(t){return t.img[0]==i[0]});null!=n&&a.setloaded(n)}})},e),a.imagelist.forEach(function(t){a.observer.observe(t.img[0])})}}setloaded(e){let i=this;t(e.img).on("load",function(){i.message("Image loaded",e),i.loadimage(e)}).on("error",function(){e.error=!0,i.loadimage(e),i.message("Image load error",e)}).on("load error",function(){null!=i.timeout&&i.timeoutlast-(Date.now()-i.timeoutlasttime)>i.timeoutstep&&(i.message("Reset timeout",i.timeoutlast-(Date.now()-i.timeoutlasttime),i.timeoutstep),i.timeoutlasttime=Date.now(),i.timeoutlast=0,clearTimeout(i.timeout),i.timeout=setTimeout(i.splitrows.bind(i),0,0))}),t(e.img)[0].complete&&t(e.img).trigger("load")}loadimage(t){let e=this;t.loaded=!0,t.width=0,t.img.css({margin:0,padding:e.margin,background:"#fff"})}message(...t){let e=this;if(e.showerrors){let i=Date.now();console.log(i-e.time+" ms:",...t)}}setcolumns(){let e=this;if(e.message("Set Columns"),e.allloaded?e.containerwidth=t(e.container).width():(e.container.height(1e9),e.containerwidth=t(e.container).width(),e.container.height("auto")),e.message("Container width",e.containerwidth),e.maxcolumn=parseInt(e.containerwidth/e.minwidth),e.maxcolumn>e.maxrow&&(e.maxcolumn=e.maxrow),e.maxcolumn<1&&(e.maxcolumn=1),e.message("Max columns",e.maxcolumn),e.allloaded){if(e.containerwidth==e.last_containerwidth&&e.maxcolumn==e.last_column)return void e.message("Skip, same previous position",e.imagelist);if(1==e.maxcolumn)return e.message("1 column, autosize"),e.last_column!=e.maxcolumn&&t("img",e.container).height("auto").css("width","100%"),void(e.last_column=e.maxcolumn)}e.last_containerwidth=e.containerwidth,e.last_column=e.maxcolumn,e.splitrows()}splitrows(t=0){let e=this;if(e.message("Split rows check","timeout:",t),e.allloaded)return void e.setrow(e.imagelist.length);let i=0,a=0,o=0,n=0,s=0;for(;a<e.imagelist.length;)e.imagelist[a].loaded?(0==s&&(o=a),n=a):(e.message("Image",a,"Not loaded yet"),s++),a++;for(e.lazyload?(i=n+e.maxcolumn,i>e.imagelist.length&&(i=e.imagelist.length)):e.placeholder&&o+1<e.imagelist.length?(i=o+parseInt(t/e.timeoutstep)*e.maxcolumn,i=Math.min(i,e.imagelist.length)):e.lazyload||(i=o+1),a=0;a<i;)(e.lazyload||e.placeholder||e.showerrors||e.imagelist[a].loaded&&!e.imagelist[a].error)&&(e.message("Show image",a),e.imagelist[a].img.fadeIn("slow")),a++;i<e.imagelist.length||s>0?(e.message("Image max calculate",i),(i>e.lasti||s<e.lastnoloaded)&&(e.lasti=i,e.lastnoloaded=s,e.setrow(i)),null!=e.timeout&&clearTimeout(e.timeout),e.timeoutlast=t+e.timeoutstep,e.timeoutlasttime=Date.now(),e.timeout=setTimeout(e.splitrows.bind(e),e.timeoutlast,e.timeoutlast)):(e.message("All images loaded"),e.allloaded=!0,e.setrow(i),e.setcolumns()),e.message("split rows finished","position ",i,"total ",e.imagelist.length)}setrow(e){let i=this;i.message("Set rows"),t(".split,.loading",i.container).remove();let a=0;if(1==i.maxcolumn)return i.message("1 column, autosize"),void t("img",i.container).height("auto").css("width","100%");for(;a<e;){let o=0,n=0,s=[];for(;o<=i.containerwidth&&n<i.maxcolumn&&a<e;){0==i.imagelist[a].width&&(t(i.imagelist[a].img).width("auto").height(i.minheight),i.imagelist[a].width=t(i.imagelist[a].img).width());let e=i.imagelist[a].width;e<i.minwidth&&(e=i.minwidth),!i.imagelist[a].error||i.showerrors?(o+=e,(o<=i.containerwidth||0==s.length)&&(s.push(i.imagelist[a]),a++),n++):a++}s.length>0&&i.setwidth(s)}i.message("Set rows finished ",e," images"),e<i.imagelist.length&&i.container.append("<div class='loading'>loading...</div>")}setwidth(e){let i=this,a=.01;i.message("Set width ",e.length," images in this row",e);let o=0,n=0,s=0;t.each(e,function(){0==this.width?n++:(0==s||s>this.width)&&(s=this.width),o+=this.width});let l=(i.containerwidth-2*i.margin*e.length)/o;l*=1-n/e.length,i.message("Proportion",l," missing images",n),i.maxcolumn>1&&1==e.length&&1.33*i.minheight>e[0].width&&0!=e[0].width?(i.message("Image too long, resize",e[0]),t(e[0].img).width("auto").height(2*i.minheight)):t.each(e,function(){0==this.width?t(this.img).width(l*s-a).height(l*i.minheight-a):t(this.img).width(l*this.width-a).height("auto")});for(var m=e.pop().img;m.parent()[0]!=i.container[0];)m=m.parent();t('<br class="split"/>').insertAfter(m)}}t.fn.ImageHeight=function(i){var a=t.extend({minwidth:300,minheight:100,maxrow:5,margin:10,lazyload:!1,placeholder:!1,showerrors:!1},i);return new e(this,a)}})(jQuery);
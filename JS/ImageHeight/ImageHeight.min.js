(function(e){class t{constructor(t,i){let o=this;if(o.container=t,1!=o.container.length)throw new Error('Container object "'+t+'" not valid');if(o.minwidth=i.minwidth,o.minheight=i.minheight,o.maxrow=i.maxrow,o.margin=i.margin,o.lazyload=i.lazyload,o.placeholder=i.placeholder,o.showerrors=i.showerrors,o.imagelist=[],o.last_containerwidth=0,o.last_column=0,o.containerwidth=null,o.lasti=0,o.maxcolumn=1,o.allloaded=!1,o.timeoutstep=50,o.timeout=null,o.time=Date.now(),o.message("Container",o.container),e("a",o.container).css({padding:0,"font-size":0,margin:0}),e("img",o.container).css({"max-width":"100%",margin:o.margin,background:"#cccccc",height:o.minheight}).hide(),e("img",o.container).each(function(){let t={img:e(this),loaded:!1,error:!1,width:0};o.imagelist.push(t),o.lazyload?e(this).show():(e(this).on("load",function(){o.message("Image loaded",t),o.loadimage(t)}).on("error",function(){t.error=!0,o.loadimage(t),o.message("Image load error",t)}),this.complete&&e(this).trigger("load"))}),o.message("Image list",o.imagelist),0==o.imagelist.length)throw new Error("No valid images to show");if(e(document).ready(function(){o.message("Start Process..."),o.setcolumns(),e(window).on("resize",function(){o.time=Date.now()}),e(window).on("load resize",function(){o.message("onload resize"),o.setcolumns()})}),o.lazyload){const t={root:null,rootMargin:"0px",threshold:0};o.observer=new IntersectionObserver(function(t){Array.prototype.forEach.call(t,function(t){if(t.isIntersecting&&(o.observer.unobserve(t.target),"img"==t.target.tagName.toLowerCase())){let i=e(t.target),a=i.data("src");if(a){i.prop("src",a),i.data("src","");const e=o.imagelist.find(e=>(console.log(e,e.img,i),e.img==i));console.log(e)}}})},t),o.imagelist.forEach(function(e){o.observer.observe(e.img[0])})}}loadimage(e){let t=this;e.loaded=!0,e.width=0,e.img.css({margin:0,padding:t.margin,background:"#fff"})}message(...e){let t=this;if(t.showerrors){let i=Date.now();console.log(i-t.time+" ms:",...e)}}setcolumns(){let t=this;if(t.message("Set Columns"),t.allloaded?t.containerwidth=e(t.container).width():(t.container.height(1e9),t.containerwidth=e(t.container).width(),t.container.height("auto")),t.message("Container width",t.containerwidth),t.maxcolumn=parseInt(t.containerwidth/t.minwidth),t.maxcolumn>t.maxrow&&(t.maxcolumn=t.maxrow),t.maxcolumn<1&&(t.maxcolumn=1),t.message("Max columns",t.maxcolumn),t.allloaded){if(t.containerwidth==t.last_containerwidth&&t.maxcolumn==t.last_column)return void t.message("Skip, same previous position",t.imagelist);if(1==t.maxcolumn)return t.message("1 column, autosize"),t.last_column!=t.maxcolumn&&e("img",t.container).height("auto").css("width","100%"),void(t.last_column=t.maxcolumn)}t.last_containerwidth=t.containerwidth,t.last_column=t.maxcolumn,t.splitrows()}splitrows(e=0){let t=this;if(t.lazyload&&e>4*t.timeoutstep&&(e=t.timeoutstep),t.message("Split rows check","timeout:",e),t.allloaded)return void t.setrow(t.imagelist.length);let i=0,o=0,a=0,s=0;for(;o<t.imagelist.length;)t.imagelist[o].loaded?0==s&&(a=o):(t.message("Image",o,"Not loaded yet"),s++),o++;for(t.placeholder&&a+1<t.imagelist.length?(i=a+parseInt(e/t.timeoutstep)*t.maxcolumn,i=Math.min(i,t.imagelist.length)):i=a+1,o=0;o<i;)(t.placeholder||t.showerrors||t.imagelist[o].loaded&&!t.imagelist[o].error)&&(t.message("Show image",o),t.imagelist[o].img.fadeIn("slow")),o++;i<t.imagelist.length||s>0?(t.message("Image max calculate",i),i>t.lasti&&(t.lasti=i,t.setrow(i)),null!=t.timeout&&clearTimeout(t.timeout),t.timeout=setTimeout(t.splitrows.bind(t),e+t.timeoutstep,e+t.timeoutstep)):(t.message("All images loaded"),t.allloaded=!0,t.setrow(i),t.setcolumns()),t.message("split rows finished","position ",i,"total ",t.imagelist.length)}setrow(t){let i=this;i.message("Set rows"),e(".split,.loading",i.container).remove();let o=0;if(1==i.maxcolumn)return i.message("1 column, autosize"),void e("img",i.container).height("auto").css("width","100%");for(;o<t;){let a=0,s=0,n=[];for(;a<=i.containerwidth&&s<i.maxcolumn&&o<t;){0==i.imagelist[o].width&&(e(i.imagelist[o].img).width("auto").height(i.minheight),i.imagelist[o].width=e(i.imagelist[o].img).width());let t=i.imagelist[o].width;t<i.minwidth&&(t=i.minwidth),!i.imagelist[o].error||i.showerrors?(a+=t,(a<=i.containerwidth||0==n.length)&&(n.push(i.imagelist[o]),o++),s++):o++}n.length>0&&i.setwidth(n)}i.message("Set rows finished ",t," images"),t<i.imagelist.length&&i.container.append("<div class='loading'>loading...</div>")}setwidth(t){let i=this,o=.01;i.message("Set width ",t.length," images in this row",t);let a=0,s=0,n=0;e.each(t,function(){0==this.width?s++:(0==n||n>this.width)&&(n=this.width),a+=this.width});let l=(i.containerwidth-2*i.margin*t.length)/a;l*=1-s/t.length,i.message("Proportion",l," missing images",s),i.maxcolumn>1&&1==t.length&&1.33*i.minheight>t[0].width&&0!=t[0].width?(i.message("Image too long, resize",t[0]),e(t[0].img).width("auto").height(2*i.minheight)):e.each(t,function(){0==this.width?e(this.img).width(l*n-o).height(l*i.minheight-o):e(this.img).width(l*this.width-o).height("auto")});for(var m=t.pop().img;m.parent()[0]!=i.container[0];)m=m.parent();e('<br class="split"/>').insertAfter(m)}}e.fn.ImageHeight=function(i){var o=e.extend({minwidth:300,minheight:100,maxrow:5,margin:10,lazyload:!1,placeholder:!1,showerrors:!1},i);return new t(this,o)}})(jQuery);
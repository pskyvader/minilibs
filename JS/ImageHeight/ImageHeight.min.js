(function(i){class e{constructor(e,t){let o=this;if(o.container=e,1!=o.container.length)throw new Error('Container object "'+e+'" not valid');if(o.minwidth=t.minwidth,o.minheight=t.minheight,o.maxrow=t.maxrow,o.margin=t.margin,o.placeholder=t.placeholder,o.showerrors=t.showerrors,o.imagelist=[],o.last_containerwidth=0,o.last_column=0,o.containerwidth=null,o.lasti=0,o.maxcolumn=1,o.allloaded=!1,o.timeoutstep=50,o.timeout=null,o.time=Date.now(),o.message("Container",o.container),i("a",o.container).css({padding:0,"font-size":0,margin:0}),i("img",o.container).css({"max-width":"100%",margin:o.margin,background:"#cccccc",height:o.minheight}).hide(),i("img",o.container).each(function(){let e={img:i(this),loaded:!1,error:!1,width:0};o.imagelist.push(e),i(this).on("load error",function(){e.loaded=!0,e.width=0,e.img.css({margin:0,padding:o.margin,background:"#fff"})}).on("load",function(){o.message("Image loaded",e)}).on("error",function(){e.error=!0,o.message("Image load error",e)}),this.complete&&i(this).trigger("load")}),o.message("Image list",o.imagelist),0==o.imagelist.length)throw new Error("No valid images to show");i(document).ready(function(){o.message("Start Process..."),o.setcolumns(),i(window).on("resize",function(){o.time=Date.now()}),i(window).on("load resize",function(){o.message("onload resize"),o.setcolumns()})})}message(...i){let e=this;if(e.showerrors){let t=Date.now();console.log(t-e.time+" ms:",...i)}}setcolumns(){let e=this;if(e.message("Set Columns"),e.allloaded?e.containerwidth=i(e.container).width():(e.container.height(1e9),e.containerwidth=i(e.container).width(),e.container.height("auto")),e.message("Container width",e.containerwidth),e.maxcolumn=parseInt(e.containerwidth/e.minwidth),e.maxcolumn>e.maxrow&&(e.maxcolumn=e.maxrow),e.maxcolumn<1&&(e.maxcolumn=1),e.message("Max columns",e.maxcolumn),e.allloaded){if(e.containerwidth==e.last_containerwidth&&e.maxcolumn==e.last_column)return void e.message("Skip, same previous position",e.imagelist);if(1==e.maxcolumn)return e.message("1 column, autosize"),e.last_column!=e.maxcolumn&&i("img",e.container).height("auto").css("width","100%"),void(e.last_column=e.maxcolumn)}e.last_containerwidth=e.containerwidth,e.last_column=e.maxcolumn,e.splitrows()}splitrows(i=0){let e=this;if(e.message("Split rows check","timeout:",i),e.allloaded)return void e.setrow(e.imagelist.length);let t=0,o=0,a=0,n=0;for(;o<e.imagelist.length;)e.imagelist[o].loaded?0==n&&(a=o):(e.message("Image",o,"Not loaded yet"),n++),o++;for(e.placeholder&&a+1<e.imagelist.length?(t=a+parseInt(i/e.timeoutstep)*e.maxcolumn,t=Math.min(t,e.imagelist.length)):t=a+1,o=0;o<t;)(e.placeholder||e.showerrors||e.imagelist[o].loaded&&!e.imagelist[o].error)&&(e.message("Show image",o),e.imagelist[o].img.fadeIn("slow")),o++;t<e.imagelist.length||n>0?(e.message("Image max calculate",t),t>e.lasti&&(e.lasti=t,e.setrow(t)),null!=e.timeout&&clearTimeout(e.timeout),e.timeout=setTimeout(e.splitrows.bind(e),i+e.timeoutstep,i+e.timeoutstep)):(e.message("All images loaded"),e.allloaded=!0,e.setrow(t),e.setcolumns()),e.message("split rows finished","position ",t,"total ",e.imagelist.length)}setrow(e){let t=this;t.message("Set rows"),i(".split,.loading",t.container).remove();let o=0;if(1==t.maxcolumn)return t.message("1 column, autosize"),void i("img",t.container).height("auto").css("width","100%");for(;o<e;){let a=0,n=0,s=[];for(;a<=t.containerwidth&&n<t.maxcolumn&&o<e;){0==t.imagelist[o].width&&(i(t.imagelist[o].img).width("auto").height(t.minheight),t.imagelist[o].width=i(t.imagelist[o].img).width());let e=t.imagelist[o].width;e<t.minwidth&&(e=t.minwidth),!t.imagelist[o].error||t.showerrors?(a+=e,(a<=t.containerwidth||0==s.length)&&(s.push(t.imagelist[o]),o++),n++):o++}s.length>0&&t.setwidth(s)}t.message("Set rows finished ",e," images"),e<t.imagelist.length&&t.container.append("<div class='loading'>loading...</div>")}setwidth(e){let t=this,o=.01;t.message("Set width ",e.length," images in this row",e);let a=0,n=0,s=0;i.each(e,function(){0==this.width?n++:(0==s||s>this.width)&&(s=this.width),a+=this.width});let m=(t.containerwidth-2*t.margin*e.length)/a;m*=1-n/e.length,t.message("Proportion",m," missing images",n),t.maxcolumn>1&&1==e.length&&1.33*t.minheight>e[0].width&&0!=e[0].width?(t.message("Image too long, resize",e[0]),i(e[0].img).width("auto").height(2*t.minheight)):i.each(e,function(){0==this.width?i(this.img).width(m*s-o).height(m*t.minheight-o):i(this.img).width(m*this.width-o).height("auto")});for(var l=e.pop().img;l.parent()[0]!=t.container[0];)l=l.parent();i('<br class="split"/>').insertAfter(l)}}i.fn.ImageHeight=function(t){var o=i.extend({minwidth:300,minheight:100,maxrow:5,margin:10,placeholder:!1,showerrors:!1},t);return new e(this,o)}})(jQuery);
(function(e){class t{constructor(t,i){let a=this;if(a.container=t,1!=a.container.length)throw new Error('Container object "'+t+'" not valid');if(a.minwidth=i.minwidth,a.minheight=i.minheight,a.maxrow=i.maxrow,a.margin=i.margin,a.lazyload=i.lazyload,a.placeholder=i.placeholder,a.showerrors=i.showerrors,a.imagelist=[],a.last_containerwidth=0,a.last_column=0,a.containerwidth=null,a.lasti=0,a.lastnoloaded=0,a.maxcolumn=1,a.allloaded=!1,a.timeoutstep=50,a.timeout=null,a.time=Date.now(),a.message("Container",a.container),e("a",a.container).css({padding:0,"font-size":0,margin:0}),e("img",a.container).css({"max-width":"100%",margin:a.margin,background:"#cccccc"}),a.lazyload?e(this).css({width:"100%",height:10*a.minheight}):e("img",a.container).css({height:a.minheight}).hide(),e("img",a.container).each(function(){let t={img:e(this),loaded:!1,error:!1,width:0};a.imagelist.push(t),a.lazyload?e(this).data("src"):a.setloaded(t)}),a.message("Image list",a.imagelist),0==a.imagelist.length)throw new Error("No valid images to show");if(e(document).ready(function(){a.message("Start Process..."),a.setcolumns(),e(window).on("resize",function(){a.time=Date.now()}),e(window).on("load resize",function(){a.message("onload resize"),a.setcolumns()})}),a.lazyload){const t={root:null,rootMargin:"0px",threshold:0};a.observer=new IntersectionObserver(function(t){Array.prototype.forEach.call(t,function(t){if(t.isIntersecting&&(a.observer.unobserve(t.target),"img"==t.target.tagName.toLowerCase())){let i=e(t.target),o=i.data("src");o&&(i.prop("src",o),i.data("src",""));const n=a.imagelist.find(function(e){return e.img[0]==i[0]});null!=n&&a.setloaded(n)}})},t),a.imagelist.forEach(function(e){a.observer.observe(e.img[0])})}}setloaded(t){let i=this;e(t.img).on("load",function(){i.message("Image loaded",t),i.loadimage(t)}).on("error",function(){t.error=!0,i.loadimage(t),i.message("Image load error",t)}),e(t.img).complete&&e(t.img).trigger("load")}loadimage(e){let t=this;e.loaded=!0,e.width=0,e.img.css({margin:0,padding:t.margin,background:"#fff"})}message(...e){let t=this;if(t.showerrors){let i=Date.now();console.log(i-t.time+" ms:",...e)}}setcolumns(){let t=this;if(t.message("Set Columns"),t.allloaded?t.containerwidth=e(t.container).width():(t.container.height(1e9),t.containerwidth=e(t.container).width(),t.container.height("auto")),t.message("Container width",t.containerwidth),t.maxcolumn=parseInt(t.containerwidth/t.minwidth),t.maxcolumn>t.maxrow&&(t.maxcolumn=t.maxrow),t.maxcolumn<1&&(t.maxcolumn=1),t.message("Max columns",t.maxcolumn),t.allloaded){if(t.containerwidth==t.last_containerwidth&&t.maxcolumn==t.last_column)return void t.message("Skip, same previous position",t.imagelist);if(1==t.maxcolumn)return t.message("1 column, autosize"),t.last_column!=t.maxcolumn&&e("img",t.container).height("auto").css("width","100%"),void(t.last_column=t.maxcolumn)}t.last_containerwidth=t.containerwidth,t.last_column=t.maxcolumn,t.splitrows()}splitrows(e=0){let t=this;if(t.lazyload&&e>4*t.timeoutstep&&(e=t.timeoutstep),t.message("Split rows check","timeout:",e),t.allloaded)return void t.setrow(t.imagelist.length);let i=0,a=0,o=0,n=0,s=0;for(;a<t.imagelist.length;)t.imagelist[a].loaded?(0==s&&(o=a),n=a):(t.message("Image",a,"Not loaded yet"),s++),a++;for(t.lazyload?(i=n+t.maxcolumn,i>t.imagelist.length&&(i=t.imagelist.length)):t.placeholder&&o+1<t.imagelist.length?(i=o+parseInt(e/t.timeoutstep)*t.maxcolumn,i=Math.min(i,t.imagelist.length)):t.lazyload||(i=o+1),a=0;a<i;)(t.lazyload||t.placeholder||t.showerrors||t.imagelist[a].loaded&&!t.imagelist[a].error)&&(t.message("Show image",a),t.imagelist[a].img.fadeIn("slow")),a++;i<t.imagelist.length||s>0?(t.message("Image max calculate",i),(i>t.lasti||s<t.lastnoloaded)&&(t.lasti=i,t.lastnoloaded=s,t.setrow(i)),null!=t.timeout&&clearTimeout(t.timeout),t.timeout=setTimeout(t.splitrows.bind(t),e+t.timeoutstep,e+t.timeoutstep)):(t.message("All images loaded"),t.allloaded=!0,t.setrow(i),t.setcolumns()),t.message("split rows finished","position ",i,"total ",t.imagelist.length)}setrow(t){let i=this;i.message("Set rows"),e(".split,.loading",i.container).remove();let a=0;if(1==i.maxcolumn)return i.message("1 column, autosize"),void e("img",i.container).height("auto").css("width","100%");for(;a<t;){let o=0,n=0,s=[];for(;o<=i.containerwidth&&n<i.maxcolumn&&a<t;){0==i.imagelist[a].width&&(e(i.imagelist[a].img).width("auto").height(i.minheight),i.imagelist[a].width=e(i.imagelist[a].img).width());let t=i.imagelist[a].width;t<i.minwidth&&(t=i.minwidth),!i.imagelist[a].error||i.showerrors?(o+=t,(o<=i.containerwidth||0==s.length)&&(s.push(i.imagelist[a]),a++),n++):a++}s.length>0&&i.setwidth(s)}i.message("Set rows finished ",t," images"),t<i.imagelist.length&&i.container.append("<div class='loading'>loading...</div>")}setwidth(t){let i=this,a=.01;i.message("Set width ",t.length," images in this row",t);let o=0,n=0,s=0;e.each(t,function(){0==this.width?n++:(0==s||s>this.width)&&(s=this.width),o+=this.width});let l=(i.containerwidth-2*i.margin*t.length)/o;l*=1-n/t.length,i.message("Proportion",l," missing images",n),i.maxcolumn>1&&1==t.length&&1.33*i.minheight>t[0].width&&0!=t[0].width?(i.message("Image too long, resize",t[0]),e(t[0].img).width("auto").height(2*i.minheight)):e.each(t,function(){0==this.width?e(this.img).width(l*s-a).height(l*i.minheight-a):e(this.img).width(l*this.width-a).height("auto")});for(var m=t.pop().img;m.parent()[0]!=i.container[0];)m=m.parent();e('<br class="split"/>').insertAfter(m)}}e.fn.ImageHeight=function(i){var a=e.extend({minwidth:300,minheight:100,maxrow:5,margin:10,lazyload:!1,placeholder:!1,showerrors:!1},i);return new t(this,a)}})(jQuery);